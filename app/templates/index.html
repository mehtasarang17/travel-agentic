<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Agentic Travel Planner - Chatbot</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #0b1220; color: #e8eefc; }
    h2 { margin: 0 0 8px; }
    .muted { color: #9db0d5; font-size: 12px; }

    .layout { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
    @media (max-width: 980px){ .layout{ grid-template-columns: 1fr; } }

    .panel { border: 1px solid #1b2a4a; border-radius: 12px; padding: 12px; background: #0f1930; }

    /* Chat UI */
    .chatWrap { display: flex; flex-direction: column; height: 520px; }
    .chatHeader { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 8px; }
    .chatBody { flex: 1; overflow: auto; padding: 10px; border: 1px solid #1b2a4a; border-radius: 10px; background: #0b1427; }
    .msg { display: flex; margin: 10px 0; }
    .msg.user { justify-content: flex-end; }
    .bubble {
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .msg.user .bubble { background: #2563eb; color: white; border-bottom-right-radius: 4px; }
    .msg.assistant .bubble { background: #111f3b; border: 1px solid #1b2a4a; border-bottom-left-radius: 4px; }

    .chatInputRow { display:flex; gap: 8px; margin-top: 10px; }
    .chatInputRow textarea {
      width: 100%;
      height: 54px;
      resize: none;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #1b2a4a;
      background: #0b1427;
      color: #e8eefc;
      outline: none;
    }
    .chatInputRow button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #1b2a4a;
      background: #1f2f55;
      color: #e8eefc;
      cursor: pointer;
      min-width: 92px;
    }
    .chatInputRow button:hover { background: #263a66; }
    .chatInputRow button:disabled { opacity: .6; cursor: not-allowed; }

    .chips { display:flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 0; }
    .chip {
      font-size: 12px;
      padding: 6px 10px;
      border: 1px solid #1b2a4a;
      border-radius: 999px;
      background: #0b1427;
      cursor: pointer;
      color: #9db0d5;
    }
    .chip:hover { color: #e8eefc; border-color: #2a3f6f; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #1b2a4a; padding: 6px; text-align: left; font-size: 13px; }
    th { background: #0b1427; }
    .kpi { display:flex; gap: 10px; flex-wrap: wrap; }
    .kpi .card { border: 1px solid #1b2a4a; border-radius: 10px; padding: 10px; background: #0b1427; }
    pre { background: #0b1427; border: 1px solid #1b2a4a; border-radius: 10px; padding: 10px; overflow: auto; color: #cfe0ff; }

    /* Simple bars visualization */
    .bars { display:flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .barRow { display:flex; align-items:center; gap: 10px; }
    .barLabel { width: 180px; color: #9db0d5; font-size: 12px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .barTrack { flex: 1; height: 10px; background: #0b1427; border: 1px solid #1b2a4a; border-radius: 999px; overflow: hidden; }
    .barFill { height: 100%; background: #22c55e; width: 0%; }
    .barValue { width: 90px; text-align: right; font-size: 12px; color: #cfe0ff; }
  </style>
</head>

<body>
  <h2>Agentic Travel Planner (LLM + LangGraph)</h2>
  <div class="muted">Try: “I want to travel from Delhi to Bombay on Jan 15th 2026”</div>

  <div class="layout">
    <!-- Chat Panel -->
    <div class="panel">
      <div class="chatWrap">
        <div class="chatHeader">
          <div class="muted">conversation_id: <span id="cid">-</span></div>
          <button onclick="clearChat()" style="padding:8px 10px;">Clear</button>
        </div>

        <div id="chatBody" class="chatBody"></div>

        <div class="chips">
          <div class="chip" onclick="setPrompt('I want to travel from Delhi to Bombay on Jan 15th 2026')">Delhi → Bombay (Flights)</div>
          <div class="chip" onclick="setPrompt('I want to book hotel in Delhi from Jan 15th 2026 to Jan 20th 2026')">Hotel in Delhi</div>
          <div class="chip" onclick="setPrompt('I want to book cab from Delhi airport to Taj Palace Delhi')">Cab (Airport → Hotel)</div>
        </div>

        <div class="chatInputRow">
          <textarea id="msg" placeholder="Type your message... (Enter = send, Shift+Enter = new line)"></textarea>
          <button id="sendBtn" onclick="send()">Send</button>
        </div>
      </div>
    </div>

    <!-- Debug/Trace Panel -->
    <div class="panel">
      <h3 style="margin-top:0">Trace</h3>
      <pre id="trace">{}</pre>
    </div>
  </div>

  <!-- Results -->
  <div class="panel" style="margin-top:16px;">
    <h3 style="margin-top:0">Results</h3>
    <div id="results"><div class="muted">No results yet.</div></div>
  </div>

<script>
  let conversationId = null;

  const chatBody = document.getElementById("chatBody");
  const msgBox = document.getElementById("msg");
  const sendBtn = document.getElementById("sendBtn");

  function setPrompt(text){
    msgBox.value = text;
    msgBox.focus();
  }

  function clearChat(){
    chatBody.innerHTML = "";
    document.getElementById("trace").innerText = "{}";
    document.getElementById("results").innerHTML = "<div class='muted'>No results yet.</div>";
    conversationId = null;
    document.getElementById("cid").innerText = "-";
  }

  function appendMessage(role, text){
    const row = document.createElement("div");
    row.className = `msg ${role}`;
    const b = document.createElement("div");
    b.className = "bubble";
    b.innerText = text || "";
    row.appendChild(b);
    chatBody.appendChild(row);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function setTyping(isTyping){
    let t = document.getElementById("typing");
    if(isTyping){
      if(!t){
        t = document.createElement("div");
        t.id = "typing";
        t.className = "msg assistant";
        const b = document.createElement("div");
        b.className = "bubble";
        b.innerText = "Typing…";
        t.appendChild(b);
        chatBody.appendChild(t);
        chatBody.scrollTop = chatBody.scrollHeight;
      }
    }else{
      if(t) t.remove();
    }
  }

  function renderTable(title, rows) {
    if (!rows || !rows.length) return "";
    const cols = Object.keys(rows[0]);
    let html = `<h4>${title}</h4><table><thead><tr>`;
    for (const c of cols) html += `<th>${c}</th>`;
    html += `</tr></thead><tbody>`;
    for (const r of rows.slice(0, 10)) {
      html += "<tr>";
      for (const c of cols) html += `<td>${r[c] ?? ""}</td>`;
      html += "</tr>";
    }
    html += "</tbody></table>";
    return html;
  }

  // Simple bar chart visualization from price arrays
  function renderBars(title, rows, labelKey, priceKey) {
    if (!rows || !rows.length) return "";
    const vals = rows.map(r => Number(r[priceKey])).filter(v => Number.isFinite(v));
    if (!vals.length) return "";
    const maxV = Math.max(...vals);
    let html = `<h4>${title} (Price Visualization)</h4><div class="bars">`;
    rows.slice(0, 8).forEach(r => {
      const label = String(r[labelKey] ?? "");
      const v = Number(r[priceKey]);
      if (!Number.isFinite(v)) return;
      const pct = maxV > 0 ? Math.round((v / maxV) * 100) : 0;
      html += `
        <div class="barRow">
          <div class="barLabel" title="${label}">${label}</div>
          <div class="barTrack"><div class="barFill" style="width:${pct}%"></div></div>
          <div class="barValue">₹${v}</div>
        </div>
      `;
    });
    html += `</div>`;
    return html;
  }

  async function send() {
    const msg = msgBox.value.trim();
    if (!msg) return;

    // UI: add user bubble
    appendMessage("user", msg);
    msgBox.value = "";
    msgBox.focus();

    sendBtn.disabled = true;
    setTyping(true);

    try{
      const res = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: msg, conversation_id: conversationId })
      });

      const data = await res.json();
      if(!res.ok){
        setTyping(false);
        appendMessage("assistant", data?.error || "Something went wrong.");
        sendBtn.disabled = false;
        return;
      }

      conversationId = data.conversation_id;
      document.getElementById("cid").innerText = conversationId;

      setTyping(false);
      appendMessage("assistant", data.reply || "");

      // Trace
      document.getElementById("trace").innerText = JSON.stringify(data.trace || [], null, 2);

      // Results tables + price bars
      const out = [];
      const results = data.results || {};

      if (results.flights?.flights) {
        out.push(renderTable("Flights (top 10)", results.flights.flights));
        // visualize by airline+flight_no and price_inr
        const rows = results.flights.flights.map(r => ({
          label: `${r.airline} ${r.flight_no}`,
          price: r.price_inr
        }));
        out.push(renderBars("Flights", rows, "label", "price"));
      }

      if (results.hotels?.hotels) {
        out.push(renderTable("Hotels (top 10)", results.hotels.hotels));
        const rows = results.hotels.hotels.map(r => ({
          label: r.name,
          price: r.price_per_night_inr ?? r.price_total_inr
        }));
        out.push(renderBars("Hotels", rows, "label", "price"));
      }

      if (results.cabs?.cabs) {
        out.push(renderTable("Cabs (top 10)", results.cabs.cabs));
        const rows = results.cabs.cabs.map(r => ({
          label: `${r.vendor} ${r.type}`,
          price: r.fare_inr
        }));
        out.push(renderBars("Cabs", rows, "label", "price"));
      }

      document.getElementById("results").innerHTML = out.join("") || "<div class='muted'>No results yet.</div>";

    }catch(e){
      setTyping(false);
      appendMessage("assistant", "Network error. Please try again.");
    } finally {
      sendBtn.disabled = false;
    }
  }

  // Enter-to-send
  msgBox.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  // initial assistant greeting
  appendMessage("assistant", "Hi! Tell me what you want to book — flights, hotels, or cabs.");
</script>

</body>
</html>
