<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Agentic Travel Planner - Chatbot</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #0b1220; color: #e8eefc; }
    h2 { margin: 0 0 8px; }
    .muted { color: #9db0d5; font-size: 12px; }

    .layout { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
    @media (max-width: 980px){ .layout{ grid-template-columns: 1fr; } }

    .panel { border: 1px solid #1b2a4a; border-radius: 12px; padding: 12px; background: #0f1930; }

    /* Chat UI */
    .chatWrap { display: flex; flex-direction: column; height: 520px; }
    .chatHeader { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 8px; }
    .chatBody { flex: 1; overflow: auto; padding: 10px; border: 1px solid #1b2a4a; border-radius: 10px; background: #0b1427; }
    .msg { display: flex; margin: 10px 0; }
    .msg.user { justify-content: flex-end; }
    .bubble {
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .msg.user .bubble { background: #2563eb; color: white; border-bottom-right-radius: 4px; }
    .msg.assistant .bubble { background: #111f3b; border: 1px solid #1b2a4a; border-bottom-left-radius: 4px; }

    .chatInputRow { display:flex; gap: 8px; margin-top: 10px; }
    .chatInputRow textarea {
      width: 100%;
      height: 54px;
      resize: none;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #1b2a4a;
      background: #0b1427;
      color: #e8eefc;
      outline: none;
    }
    .chatInputRow button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #1b2a4a;
      background: #1f2f55;
      color: #e8eefc;
      cursor: pointer;
      min-width: 92px;
    }
    .chatInputRow button:hover { background: #263a66; }
    .chatInputRow button:disabled { opacity: .6; cursor: not-allowed; }

    .chips { display:flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 0; }
    .chip {
      font-size: 12px;
      padding: 6px 10px;
      border: 1px solid #1b2a4a;
      border-radius: 999px;
      background: #0b1427;
      cursor: pointer;
      color: #9db0d5;
    }
    .chip:hover { color: #e8eefc; border-color: #2a3f6f; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #1b2a4a; padding: 6px; text-align: left; font-size: 13px; }
    th { background: #0b1427; }
    pre { background: #0b1427; border: 1px solid #1b2a4a; border-radius: 10px; padding: 10px; overflow: auto; color: #cfe0ff; }

    /* Charts */
    .chartGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 980px){ .chartGrid{ grid-template-columns: 1fr; } }
    .chartCard { border: 1px solid #1b2a4a; border-radius: 12px; background: #0b1427; padding: 10px; }
    canvas { width: 100% !important; height: 280px !important; }

    .hidden { display: none !important; }
  </style>
</head>

<body>
  <h2>Agentic Travel Planner (LLM + LangGraph)</h2>
  <div class="muted">Try: “I want to travel from Delhi to Bombay on Jan 15th 2026”</div>

  <div class="layout">
    <!-- Chat Panel -->
    <div class="panel">
      <div class="chatWrap">
        <div class="chatHeader">
          <div class="muted">conversation_id: <span id="cid">-</span></div>
          <button onclick="clearChat()" style="padding:8px 10px;">Clear</button>
        </div>

        <div id="chatBody" class="chatBody"></div>

        <div class="chips">
          <div class="chip" onclick="setPrompt('I want to travel from Delhi to Bombay on Jan 15th 2026')">Want to book a Flight?</div>
          <div class="chip" onclick="setPrompt('I want to book hotel in Delhi from Jan 15th 2026 to Jan 20th 2026')">Book a Hotel Somewhere?</div>
          <div class="chip" onclick="setPrompt('I want to book cab from Delhi airport to Taj Palace Delhi')">Want to see your Cab Options?</div>
          <div class="chip" onclick="setPrompt('Show COVID updates for India')">Covid Updates</div>
        </div>

        <div class="chatInputRow">
          <textarea id="msg" placeholder="Type your message... (Enter = send, Shift+Enter = new line)"></textarea>
          <button id="sendBtn" onclick="send()">Send</button>
        </div>
      </div>
    </div>

    <!-- Trace Panel -->
    <div class="panel">
      <h3 style="margin-top:0">Trace</h3>
      <pre id="trace">{}</pre>
    </div>
  </div>

  <!-- Results -->
  <div class="panel" style="margin-top:16px;">
    <h3 style="margin-top:0">Results</h3>
    <div id="results"><div class="muted">No results yet.</div></div>

    <div class="chartGrid" id="chartGrid">
      <div class="chartCard hidden" id="cardFlights">
        <div class="muted" id="lblFlights">Flights (prices cheapest → expensive)</div>
        <canvas id="chartFlights"></canvas>
      </div>

      <div class="chartCard hidden" id="cardHotels">
        <div class="muted" id="lblHotels">Hotels (prices cheapest → expensive)</div>
        <canvas id="chartHotels"></canvas>
      </div>

      <div class="chartCard hidden" id="cardCabs">
        <div class="muted" id="lblCabs">Cabs/Transfers (prices cheapest → expensive)</div>
        <canvas id="chartCabs"></canvas>
      </div>

      <div class="chartCard hidden" id="cardCovid">
        <div class="muted" id="lblCovid">COVID (daily new cases, 2020 → today)</div>
        <canvas id="chartCovid"></canvas>
      </div>

      <div class="chartCard hidden" id="cardHistory">
        <div class="muted">Cheapest price over time (per query)</div>
        <canvas id="chartHistory"></canvas>
      </div>
    </div>
  </div>

<script>
  let conversationId = null;

  const chatBody = document.getElementById("chatBody");
  const msgBox = document.getElementById("msg");
  const sendBtn = document.getElementById("sendBtn");

  // chart instances
  let flightsChart = null;
  let hotelsChart  = null;
  let cabsChart    = null;
  let covidChart   = null;
  let historyChart = null;

  // cheapest-over-time history
  const queryHistory = [];
  let queryCount = 0;

  function setPrompt(text){
    msgBox.value = text;
    msgBox.focus();
  }

  function clearChat(){
    chatBody.innerHTML = "";
    document.getElementById("trace").innerText = "{}";
    document.getElementById("results").innerHTML = "<div class='muted'>No results yet.</div>";
    conversationId = null;
    document.getElementById("cid").innerText = "-";

    queryHistory.length = 0;
    queryCount = 0;

    destroyCharts();
    initCharts();
    hideAllChartCards();
  }

  function appendMessage(role, text){
    const row = document.createElement("div");
    row.className = `msg ${role}`;
    const b = document.createElement("div");
    b.className = "bubble";
    b.innerText = text || "";
    row.appendChild(b);
    chatBody.appendChild(row);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function setTyping(isTyping){
    let t = document.getElementById("typing");
    if(isTyping){
      if(!t){
        t = document.createElement("div");
        t.id = "typing";
        t.className = "msg assistant";
        const b = document.createElement("div");
        b.className = "bubble";
        b.innerText = "Typing…";
        t.appendChild(b);
        chatBody.appendChild(t);
        chatBody.scrollTop = chatBody.scrollHeight;
      }
    }else{
      if(t) t.remove();
    }
  }

  function renderTable(title, rows) {
    if (!rows || !rows.length) return "";
    const cols = Object.keys(rows[0]);
    let html = `<h4>${title}</h4><table><thead><tr>`;
    for (const c of cols) html += `<th>${c}</th>`;
    html += `</tr></thead><tbody>`;
    for (const r of rows.slice(0, 10)) {
      html += "<tr>";
      for (const c of cols) html += `<td>${r[c] ?? ""}</td>`;
      html += "</tr>";
    }
    html += "</tbody></table>";
    return html;
  }

  function destroyCharts(){
    [flightsChart, hotelsChart, cabsChart, covidChart, historyChart].forEach(ch => {
      if(ch){ ch.destroy(); }
    });
    flightsChart = hotelsChart = cabsChart = covidChart = historyChart = null;
  }

  function makeLineChart(canvasId, title){
    const ctx = document.getElementById(canvasId);
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: title,
          data: [],
          tension: 0.25,
          pointRadius: 2,
          pointHoverRadius: 3,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: "#cfe0ff" } },
          tooltip: { enabled: true }
        },
        scales: {
          x: { ticks: { color: "#9db0d5", maxRotation: 0, autoSkip: true }, grid: { color: "#182a4a" } },
          y: { ticks: { color: "#9db0d5" }, grid: { color: "#182a4a" } }
        }
      }
    });
  }

  function makeHistoryChart(){
    const ctx = document.getElementById("chartHistory");
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          { label: "Flights (cheapest)", data: [], tension: 0.25, pointRadius: 2, fill: false },
          { label: "Hotels (cheapest)", data: [], tension: 0.25, pointRadius: 2, fill: false },
          { label: "Cabs (cheapest)", data: [], tension: 0.25, pointRadius: 2, fill: false },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: "#cfe0ff" } },
          tooltip: { enabled: true }
        },
        scales: {
          x: { ticks: { color: "#9db0d5" }, grid: { color: "#182a4a" } },
          y: { ticks: { color: "#9db0d5" }, grid: { color: "#182a4a" } }
        }
      }
    });
  }

  function initCharts(){
    flightsChart = makeLineChart("chartFlights", "Flight prices (INR)");
    hotelsChart  = makeLineChart("chartHotels",  "Hotel prices (INR)");
    cabsChart    = makeLineChart("chartCabs",    "Cab/Transfer prices (INR)");
    covidChart   = makeLineChart("chartCovid",   "Daily new COVID cases (2020 → today)");
    historyChart = makeHistoryChart();
  }

  function updateLineChart(chart, labels, values, datasetLabel){
    if (datasetLabel) chart.data.datasets[0].label = datasetLabel;
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update();
  }

  function updateHistoryChart(){
    const labels = queryHistory.map(x => String(x.t));
    historyChart.data.labels = labels;
    historyChart.data.datasets[0].data = queryHistory.map(x => x.flights ?? null);
    historyChart.data.datasets[1].data = queryHistory.map(x => x.hotels ?? null);
    historyChart.data.datasets[2].data = queryHistory.map(x => x.cabs ?? null);
    historyChart.update();
  }

  function hideAllChartCards(){
    document.getElementById("cardFlights").classList.add("hidden");
    document.getElementById("cardHotels").classList.add("hidden");
    document.getElementById("cardCabs").classList.add("hidden");
    document.getElementById("cardCovid").classList.add("hidden");
    document.getElementById("cardHistory").classList.add("hidden");
  }

  function showRelevantCharts(results){
    // IMPORTANT: each response only shows relevant charts
    hideAllChartCards();

    const hasFlights = (results?.flights?.flights || []).length > 0;
    const hasHotels  = (results?.hotels?.hotels   || []).length > 0;
    const hasCabs    = (results?.cabs?.cabs       || []).length > 0;

    // ✅ prefer full series, fallback to last14
    const hasCovid =
      (results?.covid?.series_daily_cases || []).length > 0 ||
      (results?.covid?.last14_days || []).length > 0;

    if (hasFlights) document.getElementById("cardFlights").classList.remove("hidden");
    if (hasHotels)  document.getElementById("cardHotels").classList.remove("hidden");
    if (hasCabs)    document.getElementById("cardCabs").classList.remove("hidden");
    if (hasCovid)   document.getElementById("cardCovid").classList.remove("hidden");

    if (queryHistory.length >= 2) {
      document.getElementById("cardHistory").classList.remove("hidden");
    }
  }

  async function send() {
    const msg = msgBox.value.trim();
    if (!msg) return;

    appendMessage("user", msg);
    msgBox.value = "";
    msgBox.focus();

    sendBtn.disabled = true;
    setTyping(true);

    try{
      const res = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: msg, conversation_id: conversationId })
      });

      const data = await res.json();
      if(!res.ok){
        setTyping(false);
        appendMessage("assistant", data?.error || "Something went wrong.");
        sendBtn.disabled = false;
        return;
      }

      conversationId = data.conversation_id;
      document.getElementById("cid").innerText = conversationId;

      setTyping(false);
      appendMessage("assistant", data.reply || "");

      // Trace
      document.getElementById("trace").innerText = JSON.stringify(data.trace || [], null, 2);

      const results = data.results || {};

      // show only relevant charts for THIS response
      showRelevantCharts(results);

      // Tables
      const out = [];
      const flights = results.flights?.flights || [];
      const hotels  = results.hotels?.hotels  || [];
      const cabs    = results.cabs?.cabs      || [];
      const covid   = results.covid || null;

      if (flights.length) out.push(renderTable("Flights (top 10)", flights));
      if (hotels.length)  out.push(renderTable("Hotels (top 10)", hotels));
      if (cabs.length)    out.push(renderTable("Cabs/Transfers (top 10)", cabs));

      // COVID summary
      if (covid) {
        const totals = covid.totals || {};
        out.push(`
          <h4>COVID Updates (${covid.location || covid.country || ""})</h4>
          <div class="muted">Updated: ${covid.updated_utc || "latest available"}</div>
          <table>
            <tbody>
              <tr><th>Total cases</th><td>${totals.cases ?? ""}</td><th>Total deaths</th><td>${totals.deaths ?? ""}</td></tr>
              <tr><th>Active</th><td>${totals.active ?? ""}</td><th>Recovered</th><td>${totals.recovered ?? ""}</td></tr>
              <tr><th>Today cases</th><td>+${totals.todayCases ?? ""}</td><th>Today deaths</th><td>+${totals.todayDeaths ?? ""}</td></tr>
            </tbody>
          </table>
        `);
      }

      document.getElementById("results").innerHTML = out.join("") || "<div class='muted'>No results yet.</div>";

      // Update charts only if data exists

      if (flights.length) {
        const vals = flights.slice(0,12).map(r => Number(r.price_inr)).filter(v => Number.isFinite(v));
        const labels = vals.map((_, i) => String(i+1));
        updateLineChart(flightsChart, labels, vals, "Flight prices (INR)");
      }

      if (hotels.length) {
        const vals = hotels.slice(0,12).map(r => Number(r.price_per_night_inr ?? r.price_total_inr)).filter(v => Number.isFinite(v));
        const labels = vals.map((_, i) => String(i+1));
        updateLineChart(hotelsChart, labels, vals, "Hotel prices (INR)");
      }

      if (cabs.length) {
        const vals = cabs.slice(0,12).map(r => Number(r.fare_inr)).filter(v => Number.isFinite(v));
        const labels = vals.map((_, i) => String(i+1));
        updateLineChart(cabsChart, labels, vals, "Cab/Transfer prices (INR)");
      }

      // ✅ COVID full history chart (2020 → today), fallback to last14
      if (covid) {
        const full = covid.series_daily_cases || [];
        const last14 = covid.last14_days || [];

        if (full.length) {
          document.getElementById("lblCovid").innerText = "COVID (daily new cases, 2020 → today)";
          const labels = full.map(p => p.date);
          const values = full.map(p => Number(p.value) || 0);
          updateLineChart(covidChart, labels, values, "Daily new COVID cases (2020 → today)");
        } else if (last14.length) {
          document.getElementById("lblCovid").innerText = "COVID (last 14 days new cases)";
          const labels = last14.map(p => p.date);
          const values = last14.map(p => Number(p.new_cases) || 0);
          updateLineChart(covidChart, labels, values, "Daily new COVID cases (last 14 days)");
        }
      }

      // cheapest-over-time history
      queryCount += 1;
      const t = queryCount;

      const cheapestFlights = flights.length ? Number(flights[0].price_inr) : null;
      const cheapestHotels  = hotels.length  ? Number(hotels[0].price_per_night_inr ?? hotels[0].price_total_inr) : null;
      const cheapestCabs    = cabs.length    ? Number(cabs[0].fare_inr) : null;

      queryHistory.push({ t, flights: cheapestFlights, hotels: cheapestHotels, cabs: cheapestCabs });
      updateHistoryChart();

    }catch(e){
      setTyping(false);
      appendMessage("assistant", "Network error. Please try again.");
    } finally {
      sendBtn.disabled = false;
    }
  }

  msgBox.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  initCharts();
  hideAllChartCards();
  appendMessage("assistant", "Hi! Tell me what you want to book — flights, hotels, cabs, or COVID updates.");
</script>

</body>
</html>
